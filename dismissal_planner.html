<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dismissal Planner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0ece4;
    --surface: #faf8f4;
    --border: #e0d8cc;
    --text: #1a1714;
    --muted: #7a7268;
    --accent: #2d5a27;
    --accent-light: #e8f0e7;
    --bus: #1a4a8a;
    --bus-light: #e6edf8;
    --pickup: #7a4a00;
    --pickup-light: #fdf0dc;
    --activity: #5a1a6a;
    --activity-light: #f5e8f8;
    --override: #8a1a1a;
    --override-light: #fde8e8;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    background: var(--text);
    color: white;
    padding: 0 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    height: 60px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }
  header h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.02em; flex: 1; }
  header h1 span { color: #a8d5a2; }

  .header-nav { display: flex; gap: 8px; align-items: center; }
  .header-nav a {
    color: rgba(255,255,255,0.65);
    text-decoration: none;
    font-size: 0.85rem;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.15s;
  }
  .header-nav a:hover { background: rgba(255,255,255,0.1); color: white; }

  /* ‚îÄ‚îÄ Controls Bar ‚îÄ‚îÄ */
  .controls {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    position: sticky;
    top: 60px;
    z-index: 90;
  }

  .date-nav {
    display: flex;
    align-items: center;
    gap: 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    background: white;
  }
  .date-nav button {
    border: none;
    background: none;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 1rem;
    color: var(--muted);
    transition: background 0.15s;
  }
  .date-nav button:hover { background: var(--bg); color: var(--text); }
  #date-display {
    padding: 8px 14px;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    min-width: 180px;
    text-align: center;
  }
  #day-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    background: var(--accent);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 6px;
  }

  .btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #234820; }
  .btn-secondary { background: white; color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--bg); }
  .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

  .view-toggle {
    display: flex;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    background: white;
    margin-left: auto;
  }
  .view-btn {
    padding: 8px 14px;
    border: none;
    background: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.15s;
    border-right: 1px solid var(--border);
  }
  .view-btn:last-child { border-right: none; }
  .view-btn.active { background: var(--text); color: white; }

  /* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
  .stats-bar {
    display: flex;
    gap: 1px;
    background: var(--border);
    border-bottom: 1px solid var(--border);
  }
  .stat {
    flex: 1;
    background: var(--surface);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .stat-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .stat-info { line-height: 1.2; }
  .stat-count { font-size: 1.4rem; font-weight: 700; font-family: 'DM Mono', monospace; }
  .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .dot-bus { background: var(--bus); }
  .dot-pickup { background: var(--pickup); }
  .dot-activity { background: var(--activity); }
  .dot-unset { background: #ccc; }

  /* ‚îÄ‚îÄ Main Grid ‚îÄ‚îÄ */
  .main { padding: 20px 24px; }

  /* ‚îÄ‚îÄ Grouped View ‚îÄ‚îÄ */
  .groups { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; align-items: start; }

  .group-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  .group-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--border);
  }
  .group-icon {
    width: 32px; height: 32px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
  }
  .group-title { font-weight: 700; font-size: 0.95rem; flex: 1; }
  .group-count {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    padding: 3px 8px;
    border-radius: 20px;
  }

  /* Bus group */
  .group-bus .group-header { background: var(--bus-light); }
  .group-bus .group-icon { background: var(--bus); color: white; }
  .group-bus .group-count { background: var(--bus); color: white; }

  /* Pickup group */
  .group-pickup .group-header { background: var(--pickup-light); }
  .group-pickup .group-icon { background: var(--pickup); color: white; }
  .group-pickup .group-count { background: var(--pickup); color: white; }

  /* Activity group */
  .group-activity .group-header { background: var(--activity-light); }
  .group-activity .group-icon { background: var(--activity); color: white; }
  .group-activity .group-count { background: var(--activity); color: white; }

  /* Unset group */
  .group-unset .group-header { background: #f0f0f0; }
  .group-unset .group-icon { background: #999; color: white; }
  .group-unset .group-count { background: #999; color: white; }

  .group-body { padding: 8px; }

  /* Sub-groups (by route/activity) */
  .sub-group { margin-bottom: 6px; }
  .sub-label {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    padding: 6px 8px 4px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .assign-btn {
    font-size: 0.72rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    border: none;
    background: var(--accent-light);
    color: var(--accent);
    transition: all 0.15s;
  }
  .assign-btn:hover { background: var(--accent); color: white; }

  .student-row {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    border-radius: 6px;
    gap: 8px;
    transition: background 0.1s;
    cursor: pointer;
    border: 1px solid transparent;
  }
  .student-row:hover { background: var(--bg); }
  .student-row.override { border-color: var(--override); background: var(--override-light); }

  .student-name { flex: 1; font-size: 0.875rem; font-weight: 500; }
  .student-grade {
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    background: var(--bg);
    padding: 2px 5px;
    border-radius: 4px;
  }
  .destination-badge {
    font-size: 0.72rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  .dest-bus { background: var(--bus-light); color: var(--bus); }
  .dest-pickup { background: var(--pickup-light); color: var(--pickup); }
  .dest-activity { background: var(--activity-light); color: var(--activity); }
  .dest-unset { background: #f0f0f0; color: #999; }
  .dest-override { background: var(--override-light); color: var(--override); border: 1px solid var(--override); }
  .override-star { color: var(--override); font-size: 0.75rem; }

  /* ‚îÄ‚îÄ List View ‚îÄ‚îÄ */
  .list-view { display: none; }
  .list-view.active { display: block; }
  .group-view { display: block; }
  .group-view.hidden { display: none; }

  .list-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--text); color: white; }
  thead th { padding: 10px 14px; text-align: left; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; cursor: pointer; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--bg); }
  tbody tr.override-row { background: var(--override-light); }
  tbody td { padding: 9px 14px; font-size: 0.875rem; }

  /* Filter bar above list */
  .filter-bar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
  .filter-chip {
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: white;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .filter-chip.active { background: var(--text); color: white; border-color: var(--text); }

  /* Search */
  .search-wrap { position: relative; }
  .search-wrap input {
    padding: 8px 12px 8px 34px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    background: white;
    width: 200px;
    outline: none;
  }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 0.9rem; pointer-events: none; }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: white;
    border-radius: 16px;
    padding: 24px;
    width: 440px;
    max-width: 95vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  .modal h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
  .modal .student-info { color: var(--muted); font-size: 0.85rem; margin-bottom: 20px; }
  .modal label { display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 6px; }
  .modal select, .modal input[type=text] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
    margin-bottom: 14px;
    background: white;
  }
  .modal select:focus, .modal input:focus { border-color: var(--accent); }
  .type-pills { display: flex; gap: 8px; margin-bottom: 14px; }
  .type-pill {
    flex: 1; padding: 10px; border-radius: 8px; border: 2px solid var(--border);
    cursor: pointer; text-align: center; font-size: 0.85rem; font-weight: 600;
    transition: all 0.15s; background: white;
  }
  .type-pill.sel-bus { border-color: var(--bus); background: var(--bus-light); color: var(--bus); }
  .type-pill.sel-pickup { border-color: var(--pickup); background: var(--pickup-light); color: var(--pickup); }
  .type-pill.sel-activity { border-color: var(--activity); background: var(--activity-light); color: var(--activity); }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; }

  /* ‚îÄ‚îÄ Bulk Assign Modal ‚îÄ‚îÄ */
  .bulk-modal { width: 500px; }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  .toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--text); color: white;
    padding: 10px 20px; border-radius: 8px;
    font-size: 0.875rem; font-weight: 500;
    transition: transform 0.3s; z-index: 300; pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { background: var(--accent); }
  .toast.error { background: var(--override); }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty { text-align: center; padding: 40px; color: var(--muted); }
  .empty-icon { font-size: 2.5rem; margin-bottom: 8px; }
  .empty p { font-size: 0.875rem; }

  @media (max-width: 640px) {
    .controls { padding: 10px 12px; }
    .main { padding: 12px; }
    .groups { grid-template-columns: 1fr; }
    header { padding: 0 12px; }
    .header-nav { display: none; }
    .view-toggle { margin-left: 0; }
    .stats-bar { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<header>
  <h1>üè´ <span>Dismissal</span> Planner</h1>
  <div class="header-nav">
    <a href="/">üìã Attendance</a>
    <a href="/mcard">üí≥ M Card</a>
  </div>
</header>

<!-- Controls -->
<div class="controls">
  <div class="date-nav">
    <button onclick="changeDate(-1)" title="Previous day">‚Äπ</button>
    <div id="date-display">Loading...</div>
    <button onclick="changeDate(1)" title="Next day">‚Ä∫</button>
  </div>
  <button class="btn btn-secondary" onclick="goToday()">Today</button>
  <button class="btn btn-primary" id="load-defaults-btn" onclick="loadDefaults()">
    ‚Ü∫ Load Defaults
  </button>

  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input type="text" id="search" placeholder="Search student..." oninput="applySearch()" />
  </div>

  <div class="view-toggle">
    <button class="view-btn active" onclick="setView('group')" id="btn-group">Group</button>
    <button class="view-btn" onclick="setView('list')" id="btn-list">List</button>
  </div>
</div>

<!-- Stats Bar -->
<div class="stats-bar">
  <div class="stat">
    <div class="stat-dot dot-bus"></div>
    <div class="stat-info">
      <div class="stat-count" id="stat-bus">‚Äî</div>
      <div class="stat-label">Bus</div>
    </div>
  </div>
  <div class="stat">
    <div class="stat-dot dot-pickup"></div>
    <div class="stat-info">
      <div class="stat-count" id="stat-pickup">‚Äî</div>
      <div class="stat-label">Pick Up</div>
    </div>
  </div>
  <div class="stat">
    <div class="stat-dot dot-activity"></div>
    <div class="stat-info">
      <div class="stat-count" id="stat-activity">‚Äî</div>
      <div class="stat-label">Activity / Aftercare</div>
    </div>
  </div>
  <div class="stat">
    <div class="stat-dot dot-unset"></div>
    <div class="stat-info">
      <div class="stat-count" id="stat-unset">‚Äî</div>
      <div class="stat-label">Not Set</div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main">

  <!-- Group View -->
  <div id="group-view" class="group-view">
    <div class="groups" id="groups-container">
      <div class="empty"><div class="empty-icon">üìã</div><p>Loading dismissal plan...</p></div>
    </div>
  </div>

  <!-- List View -->
  <div id="list-view" class="list-view">
    <div class="filter-bar">
      <button class="filter-chip active" onclick="setFilter('all', this)">All</button>
      <button class="filter-chip" onclick="setFilter('bus', this)">üöå Bus</button>
      <button class="filter-chip" onclick="setFilter('pickup', this)">üöó Pick Up</button>
      <button class="filter-chip" onclick="setFilter('activity', this)">‚≠ê Activity</button>
      <button class="filter-chip" onclick="setFilter('unset', this)">‚ùì Not Set</button>
    </div>
    <div class="list-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Grade</th>
            <th>Type</th>
            <th>Destination</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="list-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Student Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <h2 id="modal-student-name">Student Name</h2>
    <div class="student-info" id="modal-student-info"></div>

    <label>Dismissal Type</label>
    <div class="type-pills">
      <div class="type-pill" data-type="bus" onclick="selectType('bus')">üöå Bus</div>
      <div class="type-pill" data-type="pickup" onclick="selectType('pickup')">üöó Pick Up</div>
      <div class="type-pill" data-type="activity" onclick="selectType('activity')">‚≠ê Activity</div>
    </div>

    <div id="destination-wrap">
      <label id="dest-label">Destination</label>
      <select id="destination-select" onchange="onDestChange()">
        <option value="">‚Äî Select ‚Äî</option>
      </select>
    </div>

    <label>Notes (optional)</label>
    <input type="text" id="modal-notes" placeholder="e.g. Leaving early, parent note..." />

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveStudentDismissal()">Save</button>
    </div>
  </div>
</div>

<!-- Bulk Assign Modal -->
<div class="modal-overlay" id="bulk-modal">
  <div class="modal bulk-modal">
    <h2 id="bulk-title">Assign Bus Route</h2>
    <div class="student-info" id="bulk-info"></div>
    <label id="bulk-dest-label">Select Destination</label>
    <select id="bulk-destination">
      <option value="">‚Äî Select ‚Äî</option>
    </select>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeBulkModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveBulkAssign()">Apply to All</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = 'https://school-attendance-system-0ax5.onrender.com/api';

const BUS_ROUTES = ['Arlington','Brewster','Carmel','Dover','HOPE','Minivan','Pawling','POK','Wappingers'];
const ACTIVITIES = ['Aftercare','Piano Lessons','LS HW Club','LS MiST','MS HW Club','MS MiST','JV Soccer','V Soccer','Basketball','Tutoring','KABARET','Book Club','Other'];
const DAYS = ['sun','mon','tue','wed','thu','fri','sat'];
const DAY_NAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

let currentDate = new Date();
let allStudents = [];   // from DB with defaults
let dailyPlan = {};     // student_id -> {type, destination, notes, is_override}
let currentFilter = 'all';
let currentView = 'group';
let editingStudentId = null;
let editingType = null;
let bulkType = null;
let bulkDestination = null;
let bulkStudentIds = [];

// ‚îÄ‚îÄ Date Helpers ‚îÄ‚îÄ
function formatDate(d) {
  return d.toISOString().split('T')[0];
}
function getDayKey(d) {
  return DAYS[d.getDay()];
}
function isWeekend(d) {
  const day = d.getDay();
  return day === 0 || day === 6;
}
function updateDateDisplay() {
  const d = currentDate;
  const day = DAY_NAMES[d.getDay()];
  const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  document.getElementById('date-display').innerHTML =
    `${dateStr} <span id="day-badge">${day.toUpperCase()}</span>`;
  const isWknd = isWeekend(d);
  document.getElementById('load-defaults-btn').disabled = isWknd;
  if (isWknd) document.getElementById('load-defaults-btn').title = 'No defaults on weekends';
}
function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  updateDateDisplay();
  loadDailyPlan();
}
function goToday() {
  currentDate = new Date();
  updateDateDisplay();
  loadDailyPlan();
}

// ‚îÄ‚îÄ API Calls ‚îÄ‚îÄ
async function fetchStudents() {
  const res = await fetch(`${API}/dismissal/students`);
  if (!res.ok) throw new Error('Failed to load students');
  return res.json();
}
async function fetchDailyPlan(date) {
  const res = await fetch(`${API}/dismissal/plan/${date}`);
  if (!res.ok) throw new Error('Failed to load plan');
  return res.json();
}
async function savePlan(studentId, type, destination, notes, isOverride) {
  const res = await fetch(`${API}/dismissal/plan`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      student_id: studentId,
      dismissal_date: formatDate(currentDate),
      dismissal_type: type,
      destination: destination || '',
      notes: notes || '',
      is_override: isOverride ? 1 : 0
    })
  });
  if (!res.ok) throw new Error('Failed to save');
  return res.json();
}
async function saveBulkPlan(studentIds, type, destination) {
  const res = await fetch(`${API}/dismissal/plan/bulk`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      student_ids: studentIds,
      dismissal_date: formatDate(currentDate),
      dismissal_type: type,
      destination: destination || ''
    })
  });
  if (!res.ok) throw new Error('Failed to bulk save');
  return res.json();
}
async function loadDefaultsAPI() {
  const day = getDayKey(currentDate);
  const res = await fetch(`${API}/dismissal/load-defaults`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ date: formatDate(currentDate), day_key: day })
  });
  if (!res.ok) throw new Error('Failed to load defaults');
  return res.json();
}

// ‚îÄ‚îÄ Load & Render ‚îÄ‚îÄ
async function init() {
  updateDateDisplay();
  try {
    allStudents = await fetchStudents();
    await loadDailyPlan();
  } catch(e) {
    showToast('Error loading data: ' + e.message, 'error');
    renderError();
  }
}

async function loadDailyPlan() {
  try {
    const plan = await fetchDailyPlan(formatDate(currentDate));
    dailyPlan = {};
    plan.forEach(p => { dailyPlan[p.student_id] = p; });
    render();
  } catch(e) {
    showToast('Error loading plan', 'error');
  }
}

async function loadDefaults() {
  if (isWeekend(currentDate)) { showToast('No defaults for weekends', 'error'); return; }
  try {
    document.getElementById('load-defaults-btn').textContent = 'Loading...';
    await loadDefaultsAPI();
    await loadDailyPlan();
    showToast('Defaults loaded!', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  } finally {
    document.getElementById('load-defaults-btn').textContent = '‚Ü∫ Load Defaults';
  }
}

function getStudentPlan(s) {
  if (dailyPlan[s.student_id]) return dailyPlan[s.student_id];
  // Return null = not set for today
  return null;
}

function getDefaultType(s) {
  const day = getDayKey(currentDate);
  return s[`dismissal_${day}`] || null;
}

function render() {
  updateStats();
  if (currentView === 'group') renderGroupView();
  else renderListView();
}

function updateStats() {
  let bus=0, pickup=0, activity=0, unset=0;
  allStudents.forEach(s => {
    const p = getStudentPlan(s);
    const type = p ? p.dismissal_type : null;
    if (type === 'bus') bus++;
    else if (type === 'pickup') pickup++;
    else if (type === 'activity') activity++;
    else unset++;
  });
  document.getElementById('stat-bus').textContent = bus;
  document.getElementById('stat-pickup').textContent = pickup;
  document.getElementById('stat-activity').textContent = activity;
  document.getElementById('stat-unset').textContent = unset;
}

function matchesSearch(s) {
  const q = document.getElementById('search').value.toLowerCase().trim();
  if (!q) return true;
  return (s.first_name + ' ' + s.last_name).toLowerCase().includes(q);
}

function renderGroupView() {
  const container = document.getElementById('groups-container');

  // Collect students by type
  const groups = { bus: {}, pickup: { 'Pick Up': [] }, activity: {}, unset: { 'Not Set': [] } };

  allStudents.filter(matchesSearch).forEach(s => {
    const p = getStudentPlan(s);
    const type = p ? p.dismissal_type : null;
    const dest = p ? (p.destination || '') : '';

    if (type === 'bus') {
      const key = dest || 'No Route Assigned';
      if (!groups.bus[key]) groups.bus[key] = [];
      groups.bus[key].push(s);
    } else if (type === 'pickup') {
      groups.pickup['Pick Up'].push(s);
    } else if (type === 'activity') {
      const key = dest || 'No Activity Assigned';
      if (!groups.activity[key]) groups.activity[key] = [];
      groups.activity[key].push(s);
    } else {
      groups.unset['Not Set'].push(s);
    }
  });

  const html = [];

  // Bus Card
  const busStudentIds = Object.values(groups.bus).flat().map(s=>s.student_id);
  const busTotal = busStudentIds.length;
  html.push(`<div class="group-card group-bus">
    <div class="group-header">
      <div class="group-icon">üöå</div>
      <div class="group-title">Bus</div>
      <span class="group-count">${busTotal}</span>
      ${busTotal > 0 ? `<button class="assign-btn" onclick="openBulkModal('bus', ${JSON.stringify(busStudentIds).replace(/"/g,"'")})">Assign All</button>` : ''}
    </div>
    <div class="group-body">
      ${renderSubGroups(groups.bus, 'bus', 'route')}
      ${busTotal === 0 ? '<div class="empty" style="padding:20px"><div class="empty-icon" style="font-size:1.5rem">üöå</div><p>No bus students today</p></div>' : ''}
    </div>
  </div>`);

  // Pickup Card
  const pickupStudents = groups.pickup['Pick Up'];
  html.push(`<div class="group-card group-pickup">
    <div class="group-header">
      <div class="group-icon">üöó</div>
      <div class="group-title">Pick Up</div>
      <span class="group-count">${pickupStudents.length}</span>
    </div>
    <div class="group-body">
      ${pickupStudents.length === 0 ?
        '<div class="empty" style="padding:20px"><div class="empty-icon" style="font-size:1.5rem">üöó</div><p>No pickup students today</p></div>' :
        pickupStudents.map(s => renderStudentRow(s)).join('')}
    </div>
  </div>`);

  // Activity Card
  const actStudentIds = Object.values(groups.activity).flat().map(s=>s.student_id);
  const actTotal = actStudentIds.length;
  html.push(`<div class="group-card group-activity">
    <div class="group-header">
      <div class="group-icon">‚≠ê</div>
      <div class="group-title">Activity / Aftercare</div>
      <span class="group-count">${actTotal}</span>
      ${actTotal > 0 ? `<button class="assign-btn" onclick="openBulkModal('activity', ${JSON.stringify(actStudentIds).replace(/"/g,"'")})">Assign All</button>` : ''}
    </div>
    <div class="group-body">
      ${renderSubGroups(groups.activity, 'activity', 'activity')}
      ${actTotal === 0 ? '<div class="empty" style="padding:20px"><div class="empty-icon" style="font-size:1.5rem">‚≠ê</div><p>No activity students today</p></div>' : ''}
    </div>
  </div>`);

  // Unset Card
  const unsetStudents = groups.unset['Not Set'];
  if (unsetStudents.length > 0) {
    html.push(`<div class="group-card group-unset">
      <div class="group-header">
        <div class="group-icon">‚ùì</div>
        <div class="group-title">Not Set</div>
        <span class="group-count">${unsetStudents.length}</span>
      </div>
      <div class="group-body">
        ${unsetStudents.map(s => renderStudentRow(s)).join('')}
      </div>
    </div>`);
  }

  container.innerHTML = html.join('');
}

function renderSubGroups(subGroups, type, label) {
  const keys = Object.keys(subGroups).sort();
  if (keys.length === 0) return '';
  return keys.map(key => {
    const students = subGroups[key];
    const unassignedIds = students.filter(s => {
      const p = getStudentPlan(s);
      return p && !p.destination;
    }).map(s => s.student_id);
    return `<div class="sub-group">
      <div class="sub-label">
        ${key}
        ${key !== 'No Route Assigned' && key !== 'No Activity Assigned' ?
          `<button class="assign-btn" onclick="openBulkModal('${type}', ${JSON.stringify(students.map(s=>s.student_id)).replace(/"/g,"'")}, '${key}')">‚úì ${key}</button>` :
          `<button class="assign-btn" onclick="openBulkModal('${type}', ${JSON.stringify(students.map(s=>s.student_id)).replace(/"/g,"'")})">Assign Route</button>`
        }
      </div>
      ${students.map(s => renderStudentRow(s)).join('')}
    </div>`;
  }).join('');
}

function renderStudentRow(s) {
  const p = getStudentPlan(s);
  const type = p ? p.dismissal_type : null;
  const dest = p ? p.destination : '';
  const isOverride = p ? p.is_override : false;

  const badgeClass = isOverride ? 'dest-override' :
    type === 'bus' ? 'dest-bus' :
    type === 'pickup' ? 'dest-pickup' :
    type === 'activity' ? 'dest-activity' : 'dest-unset';

  const badgeText = dest || (type ? type.toUpperCase() : '? Not Set');

  return `<div class="student-row ${isOverride ? 'override' : ''}" onclick="openEditModal(${s.student_id})">
    <div class="student-name">${s.first_name} ${s.last_name}</div>
    <div class="student-grade">${s.grade || '?'}</div>
    ${isOverride ? '<span class="override-star" title="Override">‚òÖ</span>' : ''}
    <span class="destination-badge ${badgeClass}">${badgeText}</span>
  </div>`;
}

function renderListView() {
  const tbody = document.getElementById('list-tbody');
  const students = allStudents.filter(s => {
    if (!matchesSearch(s)) return false;
    const p = getStudentPlan(s);
    const type = p ? p.dismissal_type : 'unset';
    if (currentFilter === 'all') return true;
    if (currentFilter === 'unset') return !p || !type;
    return type === currentFilter;
  }).sort((a,b) => a.last_name.localeCompare(b.last_name));

  if (students.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--muted)">No students found</td></tr>`;
    return;
  }

  tbody.innerHTML = students.map(s => {
    const p = getStudentPlan(s);
    const type = p ? p.dismissal_type : null;
    const dest = p ? (p.destination || '') : '';
    const isOverride = p ? p.is_override : false;

    const typeBadge = type ? `<span class="destination-badge dest-${type}">${type.toUpperCase()}</span>` :
      `<span class="destination-badge dest-unset">Not Set</span>`;
    const statusBadge = isOverride ?
      `<span class="destination-badge dest-override">Override ‚òÖ</span>` :
      (p ? `<span style="color:var(--accent);font-size:0.8rem;font-weight:600">Default</span>` :
      `<span style="color:#999;font-size:0.8rem">‚Äî</span>`);

    return `<tr class="${isOverride ? 'override-row' : ''}" onclick="openEditModal(${s.student_id})">
      <td><strong>${s.last_name}</strong>, ${s.first_name}</td>
      <td>${s.grade || '‚Äî'}</td>
      <td>${typeBadge}</td>
      <td>${dest || '‚Äî'}</td>
      <td>${statusBadge}</td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ View Toggle ‚îÄ‚îÄ
function setView(v) {
  currentView = v;
  document.getElementById('group-view').className = 'group-view' + (v === 'group' ? '' : ' hidden');
  document.getElementById('list-view').className = 'list-view' + (v === 'list' ? ' active' : '');
  document.getElementById('btn-group').className = 'view-btn' + (v === 'group' ? ' active' : '');
  document.getElementById('btn-list').className = 'view-btn' + (v === 'list' ? ' active' : '');
  render();
}

function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderListView();
}

function applySearch() { render(); }

// ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ
function openEditModal(studentId) {
  editingStudentId = studentId;
  const s = allStudents.find(x => x.student_id === studentId);
  const p = getStudentPlan(s);
  editingType = p ? p.dismissal_type : getDefaultType(s);

  document.getElementById('modal-student-name').textContent = `${s.first_name} ${s.last_name}`;
  const def = getDefaultType(s);
  document.getElementById('modal-student-info').textContent =
    `Grade ${s.grade || '?'} ¬∑ Default today: ${def ? def.toUpperCase() : 'Not set'}`;
  document.getElementById('modal-notes').value = p ? (p.notes || '') : '';

  // Set type pills
  document.querySelectorAll('.type-pill').forEach(pill => {
    pill.className = 'type-pill';
    if (pill.dataset.type === editingType) {
      pill.classList.add(`sel-${editingType}`);
    }
  });

  updateDestSelect(editingType, p ? p.destination : '');
  document.getElementById('edit-modal').classList.add('open');
}

function selectType(type) {
  editingType = type;
  document.querySelectorAll('.type-pill').forEach(pill => {
    pill.className = 'type-pill';
    if (pill.dataset.type === type) pill.classList.add(`sel-${type}`);
  });
  updateDestSelect(type, '');
}

function updateDestSelect(type, currentDest) {
  const wrap = document.getElementById('destination-wrap');
  const sel = document.getElementById('destination-select');
  const lbl = document.getElementById('dest-label');

  if (type === 'pickup') {
    wrap.style.display = 'none';
    return;
  }
  wrap.style.display = 'block';

  const options = type === 'bus' ? BUS_ROUTES : ACTIVITIES;
  lbl.textContent = type === 'bus' ? 'Bus Route' : 'Activity';
  sel.innerHTML = `<option value="">‚Äî Select ‚Äî</option>` +
    options.map(o => `<option value="${o}" ${o === currentDest ? 'selected' : ''}>${o}</option>`).join('');
}

function onDestChange() {}

function closeModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingStudentId = null;
  editingType = null;
}

async function saveStudentDismissal() {
  const s = allStudents.find(x => x.student_id === editingStudentId);
  const dest = editingType === 'pickup' ? '' : document.getElementById('destination-select').value;
  const notes = document.getElementById('modal-notes').value;
  const defType = getDefaultType(s);
  const isOverride = editingType !== defType;

  try {
    await savePlan(editingStudentId, editingType, dest, notes, isOverride);
    // Update local cache
    dailyPlan[editingStudentId] = {
      student_id: editingStudentId,
      dismissal_type: editingType,
      destination: dest,
      notes: notes,
      is_override: isOverride
    };
    closeModal();
    render();
    showToast('Saved!', 'success');
  } catch(e) {
    showToast('Error saving: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ Bulk Modal ‚îÄ‚îÄ
function openBulkModal(type, studentIds, existingDest) {
  bulkType = type;
  bulkStudentIds = typeof studentIds === 'string' ? JSON.parse(studentIds.replace(/'/g,'"')) : studentIds;

  const typeLabel = type === 'bus' ? 'Bus Route' : 'Activity';
  const count = bulkStudentIds.length;
  document.getElementById('bulk-title').textContent = `Assign ${typeLabel}`;
  document.getElementById('bulk-info').textContent = `This will assign a ${typeLabel.toLowerCase()} to ${count} student${count !== 1 ? 's' : ''}`;
  document.getElementById('bulk-dest-label').textContent = typeLabel;

  const options = type === 'bus' ? BUS_ROUTES : ACTIVITIES;
  const sel = document.getElementById('bulk-destination');
  sel.innerHTML = `<option value="">‚Äî Select ‚Äî</option>` +
    options.map(o => `<option value="${o}" ${o === existingDest ? 'selected' : ''}>${o}</option>`).join('');

  document.getElementById('bulk-modal').classList.add('open');
}

function closeBulkModal() {
  document.getElementById('bulk-modal').classList.remove('open');
}

async function saveBulkAssign() {
  const dest = document.getElementById('bulk-destination').value;
  if (!dest) { showToast('Please select a destination', 'error'); return; }

  try {
    await saveBulkPlan(bulkStudentIds, bulkType, dest);
    // Update local cache
    bulkStudentIds.forEach(id => {
      const s = allStudents.find(x => x.student_id === id);
      const defType = getDefaultType(s);
      dailyPlan[id] = {
        student_id: id,
        dismissal_type: bulkType,
        destination: dest,
        notes: '',
        is_override: bulkType !== defType
      };
    });
    closeBulkModal();
    render();
    showToast(`Assigned ${dest} to ${bulkStudentIds.length} students`, 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => t.className = 'toast', 2500);
}

function renderError() {
  document.getElementById('groups-container').innerHTML =
    '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Could not connect to server. Make sure the server is running.</p></div>';
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      overlay.classList.remove('open');
    }
  });
});

init();
</script>
</body>
</html>
