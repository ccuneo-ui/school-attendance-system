<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Directory — Mizzentop</title>
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --navy:    #1a2744;
      --green:   #2d5016;
      --gold:    #c8992a;
      --cream:   #f7f3ec;
      --muted:   #6b7280;
      --border:  #e5e0d8;
      --people:  #3a5a7a;
      --active-bg:   #e8f5e9;
      --active-txt:  #2d5016;
      --inactive-bg: #fce8e8;
      --inactive-txt:#8a1a1a;
      --guest-bg:    #fff8e1;
      --guest-txt:   #7a5a00;
    }
    html, body { min-height: 100%; font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--navy); }

    /* ── Top Bar ── */
    .topbar { background: var(--navy); padding: 14px 28px; display: flex; align-items: center; gap: 16px; }
    .topbar a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 13px; font-weight: 500; transition: color 0.15s; }
    .topbar a:hover { color: white; }
    .topbar-sep { color: rgba(255,255,255,0.3); font-size: 13px; }
    .topbar-title { color: white; font-size: 13px; font-weight: 600; }

    /* ── Page ── */
    .page { max-width: 1200px; margin: 0 auto; padding: 40px 28px 80px; }
    .page-header { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 28px; flex-wrap: wrap; gap: 16px; }
    .page-header h1 { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 700; color: var(--navy); }
    .page-header p { font-size: 14px; color: var(--muted); margin-top: 4px; }

    /* ── Controls ── */
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
    .search-box { position: relative; flex: 1; min-width: 220px; max-width: 340px; }
    .search-box input { width: 100%; padding: 9px 12px 9px 36px; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 14px; background: white; outline: none; }
    .search-box input:focus { border-color: var(--people); }
    .search-box svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--muted); pointer-events: none; }
    .filter-chips { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1.5px solid var(--border); background: white; color: var(--muted); transition: all 0.15s; }
    .chip:hover { border-color: var(--people); color: var(--people); }
    .chip.active { background: var(--people); border-color: var(--people); color: white; }
    .count-badge { display: inline-block; margin-left: 5px; background: rgba(255,255,255,0.25); border-radius: 10px; padding: 0 6px; font-size: 11px; }

    /* ── Stats ── */
    .stats { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
    .stat-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 14px 20px; min-width: 120px; }
    .stat-card .num { font-size: 26px; font-weight: 700; color: var(--navy); line-height: 1; }
    .stat-card .lbl { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

    /* ── Table ── */
    .table-wrap { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { background: #f4f1eb; padding: 10px 16px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
    thead th:hover { color: var(--navy); }
    thead th.sorted { color: var(--people); }
    tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #f9f7f4; }
    td { padding: 11px 16px; vertical-align: middle; }
    .td-name { font-weight: 600; color: var(--navy); }
    .td-grade { font-size: 13px; color: var(--muted); }
    .status-pill { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; }
    .status-active   { background: var(--active-bg);   color: var(--active-txt); }
    .status-inactive { background: var(--inactive-bg); color: var(--inactive-txt); }
    .status-guest    { background: var(--guest-bg);    color: var(--guest-txt); }
    .td-dismissal { font-size: 12px; color: var(--muted); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }

    /* ── Modal ── */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 16px; width: 680px; max-width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 24px 80px rgba(0,0,0,0.22); }
    .modal-header { padding: 24px 28px 0; display: flex; align-items: flex-start; justify-content: space-between; }
    .modal-header h2 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--navy); }
    .modal-header p { font-size: 13px; color: var(--muted); margin-top: 3px; }
    .modal-close { background: none; border: none; cursor: pointer; color: var(--muted); padding: 4px; border-radius: 6px; }
    .modal-close:hover { background: var(--border); color: var(--navy); }
    .modal-body { padding: 20px 28px 28px; }
    .section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--people); margin: 20px 0 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .section-title:first-child { margin-top: 0; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
    .form-grid.full { grid-template-columns: 1fr; }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); }
    .field input, .field select, .field textarea {
      padding: 9px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--navy);
      background: white; outline: none; transition: border-color 0.15s;
    }
    .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--people); }
    .field textarea { resize: vertical; min-height: 70px; }
    .dismissal-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .dismissal-day label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); display: block; margin-bottom: 5px; text-align: center; }
    .dismissal-day select { width: 100%; padding: 7px 6px; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--navy); background: white; outline: none; text-align: center; }
    .dismissal-day select:focus { border-color: var(--people); }
    .before-care-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; }
    .before-care-row input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--people); }
    .before-care-row label { font-size: 14px; color: var(--navy); cursor: pointer; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; padding: 16px 28px 24px; border-top: 1px solid var(--border); }
    .btn { padding: 9px 20px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-secondary { background: var(--border); color: var(--navy); }
    .btn-secondary:hover { background: #d5cfc6; }
    .btn-primary { background: var(--people); color: white; }
    .btn-primary:hover { background: #2e4a66; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ── Toast ── */
    .toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--navy); color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; opacity: 0; transition: all 0.25s; pointer-events: none; z-index: 500; white-space: nowrap; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.error { background: #8a1a1a; }
  </style>
</head>
<body>

<div class="topbar">
  <a href="/">← Home</a>
  <span class="topbar-sep">/</span>
  <span class="topbar-title">Student Directory</span>
</div>

<div class="page">
  <div class="page-header">
    <div>
      <h1>Student Directory</h1>
      <p>View and edit student profiles, status, and dismissal defaults</p>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card"><div class="num" id="stat-total">—</div><div class="lbl">Total</div></div>
    <div class="stat-card"><div class="num" id="stat-active">—</div><div class="lbl">Active</div></div>
    <div class="stat-card"><div class="num" id="stat-inactive">—</div><div class="lbl">Inactive</div></div>
    <div class="stat-card"><div class="num" id="stat-guest">—</div><div class="lbl">Guest</div></div>
  </div>

  <div class="controls">
    <div class="search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <input type="text" id="search" placeholder="Search students..." oninput="render()">
    </div>
    <div class="filter-chips">
      <div class="chip active" data-filter="all" onclick="setFilter('all',this)">All <span class="count-badge" id="chip-all">—</span></div>
      <div class="chip" data-filter="active" onclick="setFilter('active',this)">Active <span class="count-badge" id="chip-active">—</span></div>
      <div class="chip" data-filter="inactive" onclick="setFilter('inactive',this)">Inactive <span class="count-badge" id="chip-inactive">—</span></div>
      <div class="chip" data-filter="guest" onclick="setFilter('guest',this)">Guest <span class="count-badge" id="chip-guest">—</span></div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('last_name')">Name</th>
          <th onclick="sortBy('grade')">Grade</th>
          <th onclick="sortBy('status')">Status</th>
          <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th>
          <th>Before Care</th>
        </tr>
      </thead>
      <tbody id="student-tbody">
        <tr><td colspan="9" class="empty-state">Loading students…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2 id="modal-title">Edit Student</h2>
        <p id="modal-subtitle"></p>
      </div>
      <button class="modal-close" onclick="closeModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">

      <div class="section-title">Status & School Info</div>
      <div class="form-grid three">
        <div class="field">
          <label>Status</label>
          <select id="f-status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="field">
          <label>Grade</label>
          <select id="f-grade">
            <option value="">— Not set —</option>
            <option value="JPK">JPK</option>
            <option value="SPK">SPK</option>
            <option value="K">K</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </div>
        <div class="field">
          <label>Enrollment Date</label>
          <input type="date" id="f-enrollment-date">
        </div>
      </div>

      <div class="section-title">Personal Information</div>
      <div class="form-grid">
        <div class="field">
          <label>First Name</label>
          <input type="text" id="f-first-name">
        </div>
        <div class="field">
          <label>Last Name</label>
          <input type="text" id="f-last-name">
        </div>
        <div class="field">
          <label>Date of Birth</label>
          <input type="date" id="f-dob">
        </div>
        <div class="field">
          <label>Email</label>
          <input type="email" id="f-email" placeholder="student or family email">
        </div>
        <div class="field">
          <label>Phone</label>
          <input type="tel" id="f-phone">
        </div>
        <div class="field full" style="grid-column:1/-1">
          <label>Address</label>
          <input type="text" id="f-address">
        </div>
      </div>

      <div class="section-title">Emergency Contact</div>
      <div class="form-grid">
        <div class="field">
          <label>Contact Name</label>
          <input type="text" id="f-ec-name">
        </div>
        <div class="field">
          <label>Contact Phone</label>
          <input type="tel" id="f-ec-phone">
        </div>
      </div>

      <div class="section-title">Dismissal Defaults</div>
      <div class="dismissal-grid">
        <div class="dismissal-day"><label>Mon</label><select id="f-mon"></select></div>
        <div class="dismissal-day"><label>Tue</label><select id="f-tue"></select></div>
        <div class="dismissal-day"><label>Wed</label><select id="f-wed"></select></div>
        <div class="dismissal-day"><label>Thu</label><select id="f-thu"></select></div>
        <div class="dismissal-day"><label>Fri</label><select id="f-fri"></select></div>
      </div>
      <div class="before-care-row">
        <input type="checkbox" id="f-before-care">
        <label for="f-before-care">Enrolled in Before Care</label>
      </div>

      <div class="section-title">Notes</div>
      <div class="form-grid full">
        <div class="field">
          <textarea id="f-notes" placeholder="Internal notes about this student…"></textarea>
        </div>
      </div>

    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveStudent()">Save Changes</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '/api';
const DISMISSAL_OPTIONS = [
  { value: '', label: '— Not set —' },
  { value: 'Pick Up', label: 'Pick Up' },
  { value: 'Arlington', label: 'Arlington' },
  { value: 'Brewster', label: 'Brewster' },
  { value: 'Carmel', label: 'Carmel' },
  { value: 'Dover', label: 'Dover' },
  { value: 'HOPE', label: 'HOPE' },
  { value: 'Minivan', label: 'Minivan' },
  { value: 'Pawling', label: 'Pawling' },
  { value: 'POK', label: 'POK' },
  { value: 'Wappingers', label: 'Wappingers' },
  { value: 'Aftercare', label: 'Aftercare' },
];

let allStudents = [];
let currentFilter = 'all';
let sortKey = 'last_name';
let sortAsc = true;
let editingId = null;

// ── Init ──
async function init() {
  populateDismissalDropdowns();
  try {
    const r = await fetch(`${API}/students`);
    allStudents = await r.json();
    updateStats();
    render();
  } catch(e) {
    document.getElementById('student-tbody').innerHTML = '<tr><td colspan="9" class="empty-state">Error loading students</td></tr>';
  }
}

function populateDismissalDropdowns() {
  ['f-mon','f-tue','f-wed','f-thu','f-fri'].forEach(id => {
    const sel = document.getElementById(id);
    DISMISSAL_OPTIONS.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.value;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });
  });
}

// ── Stats ──
function updateStats() {
  const counts = { active: 0, inactive: 0, guest: 0 };
  allStudents.forEach(s => { if (counts[s.status] !== undefined) counts[s.status]++; });
  document.getElementById('stat-total').textContent = allStudents.length;
  document.getElementById('stat-active').textContent = counts.active;
  document.getElementById('stat-inactive').textContent = counts.inactive;
  document.getElementById('stat-guest').textContent = counts.guest;
  document.getElementById('chip-all').textContent = allStudents.length;
  document.getElementById('chip-active').textContent = counts.active;
  document.getElementById('chip-inactive').textContent = counts.inactive;
  document.getElementById('chip-guest').textContent = counts.guest;
}

// ── Filter & Sort ──
function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  render();
}

function sortBy(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = true; }
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));
  render();
}

function getFiltered() {
  const q = document.getElementById('search').value.toLowerCase().trim();
  return allStudents.filter(s => {
    if (currentFilter !== 'all' && s.status !== currentFilter) return false;
    if (q && !(s.first_name + ' ' + s.last_name).toLowerCase().includes(q)) return false;
    return true;
  }).sort((a, b) => {
    let av = a[sortKey] || '', bv = b[sortKey] || '';
    // Grade sort order
    if (sortKey === 'grade') {
      const order = ['JPK','SPK','K','1','2','3','4','5','6','7','8'];
      av = order.indexOf(av); bv = order.indexOf(bv);
      if (av === -1) av = 99; if (bv === -1) bv = 99;
      return sortAsc ? av - bv : bv - av;
    }
    if (av < bv) return sortAsc ? -1 : 1;
    if (av > bv) return sortAsc ? 1 : -1;
    return 0;
  });
}

// ── Render ──
function render() {
  const students = getFiltered();
  const tbody = document.getElementById('student-tbody');
  if (!students.length) {
    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No students found</td></tr>';
    return;
  }
  tbody.innerHTML = students.map(s => {
    const name = `${s.last_name}, ${s.first_name}`;
    const statusClass = `status-${s.status || 'inactive'}`;
    const statusLabel = s.status ? s.status.charAt(0).toUpperCase() + s.status.slice(1) : '—';
    const dis = (v) => v || '<span style="color:#ccc">—</span>';
    return `<tr onclick="openModal(${s.student_id})">
      <td class="td-name">${name}</td>
      <td class="td-grade">${s.grade || '—'}</td>
      <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
      <td class="td-dismissal">${dis(s.dismissal_mon)}</td>
      <td class="td-dismissal">${dis(s.dismissal_tue)}</td>
      <td class="td-dismissal">${dis(s.dismissal_wed)}</td>
      <td class="td-dismissal">${dis(s.dismissal_thu)}</td>
      <td class="td-dismissal">${dis(s.dismissal_fri)}</td>
      <td>${s.before_care ? '✓' : ''}</td>
    </tr>`;
  }).join('');
}

// ── Modal ──
function openModal(studentId) {
  const s = allStudents.find(x => x.student_id === studentId);
  if (!s) return;
  editingId = studentId;

  document.getElementById('modal-title').textContent = `${s.first_name} ${s.last_name}`;
  document.getElementById('modal-subtitle').textContent = `Grade ${s.grade || '—'} · Student ID ${s.student_id}`;

  document.getElementById('f-status').value = s.status || 'active';
  document.getElementById('f-grade').value = s.grade || '';
  document.getElementById('f-first-name').value = s.first_name || '';
  document.getElementById('f-last-name').value = s.last_name || '';
  document.getElementById('f-dob').value = s.date_of_birth || '';
  document.getElementById('f-email').value = s.email || '';
  document.getElementById('f-phone').value = s.phone || '';
  document.getElementById('f-address').value = s.address || '';
  document.getElementById('f-ec-name').value = s.emergency_contact_name || '';
  document.getElementById('f-ec-phone').value = s.emergency_contact_phone || '';
  document.getElementById('f-enrollment-date').value = s.enrollment_date || '';
  document.getElementById('f-notes').value = s.notes || '';
  document.getElementById('f-before-care').checked = !!s.before_care;
  document.getElementById('f-mon').value = s.dismissal_mon || '';
  document.getElementById('f-tue').value = s.dismissal_tue || '';
  document.getElementById('f-wed').value = s.dismissal_wed || '';
  document.getElementById('f-thu').value = s.dismissal_thu || '';
  document.getElementById('f-fri').value = s.dismissal_fri || '';

  document.getElementById('edit-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('edit-modal').classList.remove('open');
  editingId = null;
}

async function saveStudent() {
  if (!editingId) return;
  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.textContent = 'Saving…';

  const payload = {
    first_name: document.getElementById('f-first-name').value.trim(),
    last_name: document.getElementById('f-last-name').value.trim(),
    grade: document.getElementById('f-grade').value,
    status: document.getElementById('f-status').value,
    date_of_birth: document.getElementById('f-dob').value,
    email: document.getElementById('f-email').value.trim(),
    phone: document.getElementById('f-phone').value.trim(),
    address: document.getElementById('f-address').value.trim(),
    emergency_contact_name: document.getElementById('f-ec-name').value.trim(),
    emergency_contact_phone: document.getElementById('f-ec-phone').value.trim(),
    enrollment_date: document.getElementById('f-enrollment-date').value,
    notes: document.getElementById('f-notes').value.trim(),
    before_care: document.getElementById('f-before-care').checked,
    dismissal_mon: document.getElementById('f-mon').value,
    dismissal_tue: document.getElementById('f-tue').value,
    dismissal_wed: document.getElementById('f-wed').value,
    dismissal_thu: document.getElementById('f-thu').value,
    dismissal_fri: document.getElementById('f-fri').value,
  };

  try {
    const r = await fetch(`${API}/students/${editingId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error();

    // Update local data
    const idx = allStudents.findIndex(s => s.student_id === editingId);
    if (idx !== -1) allStudents[idx] = { ...allStudents[idx], ...payload };

    updateStats();
    render();
    closeModal();
    showToast('Student saved successfully');
  } catch(e) {
    showToast('Error saving student', true);
  }

  btn.disabled = false;
  btn.textContent = 'Save Changes';
}

// ── Toast ──
function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isError ? ' error' : '');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Close modal on overlay click
document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

init();
</script>
</body>
</html>
